# 数据库管理规范（支持 SqlServer、达梦、人大金仓，面向后端MyBatis开发者）

---

## 1. 规范总则
- 本规范适用于后端开发者，指导在 SqlServer、达梦（DM）、人大金仓（KingbaseES）三种数据库的设计与开发。
- 涉及日常开发SQL、数据结构、运维、迁移与兼容相关场景。
- 推荐配合MyBatis等ORM框架使用，示例含中文注释和实际开发常见需求。

## 2. 连接配置与驱动建议
### 2.1 JDBC驱动及依赖
- SqlServer：`com.microsoft.sqlserver:mssql-jdbc`
- 达梦：`dm.jdbc.driver.DmDriver` （一般为`Dm8JdbcDriver18.jar`）
- 人大金仓：`com.kingbase8.Driver` （`kingbase8.jar`）

### 2.2 MyBatis-Config 典型配置样例
```xml
<!-- 以SqlServer为例 -->
<dataSource type="POOLED">
  <property name="driver" value="com.microsoft.sqlserver.jdbc.SQLServerDriver" />
  <property name="url" value="jdbc:sqlserver://localhost:1433;databaseName=yourdb" />
  <property name="username" value="user" />
  <property name="password" value="pass" />
</dataSource>
<!-- 达梦/人大金仓配置类似，调整驱动包与URL格式 -->
```


## 3. 常用数据类型对照表
| 逻辑类型 | SqlServer         | 达梦（DM）     | 人大金仓         |
|-----------|------------------|---------------|------------------|
| 整数      | INT, BIGINT      | INT, BIGINT   | INT8, INT4       |
| 长文本    | NVARCHAR(MAX)    | TEXT, CLOB    | TEXT, VARCHAR    |
| 短字符串  | NVARCHAR(255)    | VARCHAR(255)  | VARCHAR(255)     |
| 布尔      | BIT              | BIT           | BOOLEAN          |
| 日期时间  | DATETIME, DATE   | DATETIME      | TIMESTAMP, DATE  |
| 浮点数    | FLOAT, REAL      | FLOAT         | FLOAT8           |
| 二进制    | VARBINARY(MAX)   | BLOB          | BYTEA            |

/* 建表时优先参照对应数据类型，使用varchar而非char，避免定长浪费。*/


## 4. DDL建表与关键SQL差异
### 4.1 自增主键写法
```sql
-- SqlServer
CREATE TABLE t_demo (
  id INT IDENTITY(1,1) PRIMARY KEY, -- 自增主键
  name NVARCHAR(100) NOT NULL
);

-- 达梦（DM）
CREATE TABLE t_demo (
  id INT PRIMARY KEY,
  name VARCHAR(100) NOT NULL
);
CREATE SEQUENCE seq_demo START WITH 1;
-- 插入时: insert into t_demo(id, name) values (seq_demo.nextval, '张三');

-- 人大金仓
CREATE TABLE t_demo (
  id SERIAL PRIMARY KEY, -- SERIAL为自增整型
  name VARCHAR(100) NOT NULL
);
```
/* 注：DM推荐SEQUENCE，但Kingbase支持MySQL风格SERIAL。MyBatis场景可用selectKey配合sequence。 */

### 4.2 字段/表命名规范
- 均采用小写字母+下划线风格，如user_id、create_time。
- 避免与系统保留字重复，如user、order等，必要时加双引号/中括号/反引号保护。


## 5. DML（增删改查）与分页
### 5.1 基本CRUD通用写法
```sql
SELECT * FROM t_demo WHERE name = #{name};
INSERT INTO t_demo (name) VALUES (#{name});
UPDATE t_demo SET name = #{name} WHERE id = #{id};
DELETE FROM t_demo WHERE id = #{id};
```

### 5.2 分页SQL示例
```sql
-- SqlServer 分页
SELECT * FROM t_demo ORDER BY id OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY;

-- 达梦、人大金仓分页（推荐MySQL兼容写法）
SELECT * FROM t_demo ORDER BY id LIMIT #{offset}, #{size};
```
/* 注：MyBatis分页时可模块化分页参数。 */


## 6. 事务与隔离级别
- 通用提交/回滚：`BEGIN TRANSACTION;`、`COMMIT;`、`ROLLBACK;`
- 隔离级别控制：
    - SqlServer支持：READ COMMITTED, REPEATABLE READ, SNAPSHOT, SERIALIZABLE
    - 达梦、人大金仓：兼容主流SQL等级
- MyBatis建议用Spring统一事务管理，手动事务请谨慎。


## 7. 保留字与命名建议
- 避免直接用如“user”“order”等关键字，如需使用请加：
    - SqlServer：中括号 [user]
    - 达梦/人大金仓：双引号 "user"


## 8. 备份、恢复、导入导出
### 8.1 通用命令（需DB权限）
- SqlServer：
    - 备份：`BACKUP DATABASE dbname TO DISK='path.bak';`
    - 恢复：`RESTORE DATABASE dbname FROM DISK='path.bak';`
- 达梦：
    - 物理冷备：`backup database full to '/dm8/backup'` 
    - dexp/dimp导出导入工具
- 人大金仓：
    - 导出：`expdb -U 用户名 -D 库名 -f 文件`
    - 导入：`impdb -U 用户名 -D 库名 -f 文件`
/* 注：开发测试建议用dbeaver、Navicat等工具辅助 */


## 9. 监控、优化与索引
- 建索引建议：常用where/join字段加单列索引，大表分页字段加复合索引
- 查询慢时：
    - SqlServer可用`SET STATISTICS TIME ON`
    - 达梦/人大金仓可通过`EXPLAIN`分析执行计划
- 定期整理/重建索引防止碎片


## 10. 跨库迁移与兼容建议
- 建表语句和数据类型注意兼容性（参考第3节）
- 迁移建议用通用工具（如dbeaver导出SQL）+手工调整
- SQL中尽量避免方言特性，如TOP、ROWNUM等，统一用ORDER BY + LIMIT或OFFSET
- date/time函数、字符串处理等需查阅三库文档差异


## 11. MyBatis 使用注意
- 推荐用#{}方式绑定参数避免SQL注入
- insert自增主键建议selectKey+sequence (DM) 或useGeneratedKeys (Kingbase/SqlServer)
- 动态SQL慎用if/where，保持SQL结构清晰
- resultMap结果需根据三库字段大小写特性灵活配置


## 12. SQL规范与示例
```sql
-- 建表范例
CREATE TABLE t_user (
  user_id INT PRIMARY KEY, -- 用户ID
  user_name VARCHAR(50) NOT NULL, -- 用户名
  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 创建时间
  status INT DEFAULT 1 -- 状态 1=正常 0=禁用
);

-- 查询
SELECT user_id, user_name FROM t_user WHERE status = 1;

-- 更新
UPDATE t_user SET status = 0 WHERE user_id = #{userId};

-- 分页
-- SqlServer
SELECT * FROM t_user ORDER BY user_id OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY;
-- 达梦/人大金仓
SELECT * FROM t_user ORDER BY user_id LIMIT #{offset}, #{size};
```

## 13. 常见兼容问题与说明
1. 数据类型不完全对等，迁移时须手工调整；尤其是日期类型、布尔类型
2. SEQUENCE与自增字段差异：MyBatis配置时注意selectKey语法变化
3. 大字段（如CLOB/BLOB）操作建议分库专用SQL
4. 运算函数、字符串处理小差异需转换

---
本规范定期更新，MyBatis开发遇见特殊兼容问题请优先查阅本地官方文档或团队经验。

（完）